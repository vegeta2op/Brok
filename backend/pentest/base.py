"""Base class for pentesting modules"""

from abc import ABC, abstractmethod
from typing import List, Dict, Any
import httpx
from ..models import Vulnerability, VulnerabilityType, SeverityLevel
from ..config import settings
import asyncio


class BasePentestModule(ABC):
    """Base class for all pentesting modules"""
    
    def __init__(self):
        self.timeout = settings.request_timeout
        self.user_agent = settings.user_agent
        self.vulnerabilities: List[Vulnerability] = []
    
    @abstractmethod
    async def scan(self, url: str, context: Dict[str, Any] = None) -> List[Vulnerability]:
        """Execute the scan for this module"""
        pass
    
    @abstractmethod
    def get_module_name(self) -> str:
        """Get the name of this module"""
        pass
    
    async def make_request(
        self, 
        url: str, 
        method: str = "GET",
        headers: Dict[str, str] = None,
        data: Dict[str, Any] = None,
        params: Dict[str, Any] = None,
        follow_redirects: bool = True
    ) -> httpx.Response | None:
        """Make an HTTP request with proper error handling"""
        try:
            async with httpx.AsyncClient(
                timeout=self.timeout,
                follow_redirects=follow_redirects,
                verify=False  # For pentesting, we often need to bypass SSL verification
            ) as client:
                request_headers = {
                    "User-Agent": self.user_agent,
                    **(headers or {})
                }
                
                response = await client.request(
                    method=method,
                    url=url,
                    headers=request_headers,
                    data=data,
                    params=params
                )
                
                return response
        
        except httpx.TimeoutException:
            return None
        except Exception as e:
            print(f"Request error: {str(e)}")
            return None
    
    def create_vulnerability(
        self,
        vuln_type: VulnerabilityType,
        severity: SeverityLevel,
        title: str,
        description: str,
        affected_url: str,
        evidence: str,
        reproduction_steps: List[str],
        remediation: str,
        cwe_id: str = None,
        cvss_score: float = None
    ) -> Vulnerability:
        """Helper method to create a vulnerability"""
        import uuid
        
        vuln = Vulnerability(
            vuln_id=str(uuid.uuid4()),
            vuln_type=vuln_type,
            severity=severity,
            title=title,
            description=description,
            affected_url=affected_url,
            evidence=evidence,
            reproduction_steps=reproduction_steps,
            remediation=remediation,
            cwe_id=cwe_id,
            cvss_score=cvss_score
        )
        
        self.vulnerabilities.append(vuln)
        return vuln
    
    async def rate_limit(self):
        """Apply rate limiting between requests"""
        await asyncio.sleep(1.0 / settings.rate_limit_per_second)

