"""CSRF (Cross-Site Request Forgery) detection module"""

from typing import List, Dict, Any
from urllib.parse import urljoin
from bs4 import BeautifulSoup
from .base import BasePentestModule
from ..models import Vulnerability, VulnerabilityType, SeverityLevel


class CSRFModule(BasePentestModule):
    """CSRF vulnerability detection"""
    
    def get_module_name(self) -> str:
        return "CSRF (Cross-Site Request Forgery)"
    
    async def scan(self, url: str, context: Dict[str, Any] = None) -> List[Vulnerability]:
        """Scan for CSRF vulnerabilities"""
        self.vulnerabilities = []
        
        # Check forms for CSRF tokens
        if context and "forms" in context:
            for form in context["forms"]:
                await self.check_form_csrf_protection(url, form)
        
        # Check for SameSite cookie attribute
        await self.check_cookie_samesite(url)
        
        return self.vulnerabilities
    
    async def check_form_csrf_protection(self, base_url: str, form: Dict[str, Any]):
        """Check if a form has CSRF protection"""
        action = form.get("action", "")
        method = form.get("method", "GET").upper()
        inputs = form.get("inputs", [])
        
        # Only check state-changing methods
        if method not in ["POST", "PUT", "DELETE", "PATCH"]:
            return
        
        # Look for CSRF token in form inputs
        csrf_token_found = False
        csrf_token_names = [
            "csrf", "csrf_token", "csrftoken", "_csrf", "csrf-token",
            "token", "_token", "authenticity_token", "xsrf", "xsrf_token"
        ]
        
        for input_field in inputs:
            input_name = input_field.get("name", "").lower()
            input_type = input_field.get("type", "").lower()
            
            # Check for CSRF token by name or hidden field
            if any(csrf_name in input_name for csrf_name in csrf_token_names):
                csrf_token_found = True
                break
        
        if not csrf_token_found:
            form_url = urljoin(base_url, action) if action else base_url
            
            self.create_vulnerability(
                vuln_type=VulnerabilityType.CSRF,
                severity=SeverityLevel.MEDIUM,
                title="Missing CSRF Protection on Form",
                description=f"A {method} form lacks CSRF token protection",
                affected_url=form_url,
                evidence=f"Form action: {action}\nMethod: {method}\nNo CSRF token found in form inputs",
                reproduction_steps=[
                    f"1. Navigate to {base_url}",
                    f"2. Inspect the form with action '{action}'",
                    "3. Note the absence of CSRF token in form fields",
                    "4. Form may be vulnerable to CSRF attacks"
                ],
                remediation="Implement CSRF tokens for all state-changing operations. Use framework-provided CSRF protection. Implement SameSite cookie attribute.",
                cwe_id="CWE-352",
                cvss_score=6.5
            )
    
    async def check_cookie_samesite(self, url: str):
        """Check if cookies have SameSite attribute"""
        response = await self.make_request(url)
        
        if not response:
            return
        
        set_cookie_headers = response.headers.get_list("set-cookie")
        
        vulnerable_cookies = []
        
        for cookie in set_cookie_headers:
            cookie_lower = cookie.lower()
            
            # Check if this looks like a session cookie
            if any(name in cookie_lower for name in ["session", "auth", "token", "jsessionid"]):
                # Check for SameSite attribute
                if "samesite" not in cookie_lower:
                    cookie_name = cookie.split("=")[0] if "=" in cookie else "unknown"
                    vulnerable_cookies.append(cookie_name)
        
        if vulnerable_cookies:
            self.create_vulnerability(
                vuln_type=VulnerabilityType.CSRF,
                severity=SeverityLevel.MEDIUM,
                title="Missing SameSite Cookie Attribute",
                description="Session cookies lack the SameSite attribute, making them vulnerable to CSRF",
                affected_url=url,
                evidence=f"Cookies without SameSite: {', '.join(vulnerable_cookies)}",
                reproduction_steps=[
                    f"1. Visit {url}",
                    "2. Inspect Set-Cookie headers in the response",
                    "3. Note the absence of SameSite attribute",
                    "4. Cookies can be sent in cross-site requests"
                ],
                remediation="Set SameSite=Lax or SameSite=Strict on all session cookies. This prevents cookies from being sent in cross-site requests.",
                cwe_id="CWE-352"
            )

